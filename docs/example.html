<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
  margin: 0;
  overflow: hidden;
}

svg {
  font: 10px sans-serif;
}

.caption {
  font-weight: bold;
}

.key path {
  display: none;
}

.key line {
  stroke: #000;
  shape-rendering: crispEdges;
}

.q0-9 {
  fill: rgb(247, 251, 255);
}

.q1-9 {
  fill: rgb(222, 235, 247);
}

.q2-9 {
  fill: rgb(198, 219, 239);
}

.q3-9 {
  fill: rgb(158, 202, 225);
}

.q4-9 {
  fill: rgb(107, 174, 214);
}

.q5-9 {
  fill: rgb(66, 146, 198);
}

.q6-9 {
  fill: rgb(33, 113, 181);
}

.q7-9 {
  fill: rgb(8, 81, 156);
}

.q8-9 {
  fill: rgb(8, 48, 107);
}

</style>

<body>
  <svg id="legend">
      <g transform="translate(20,20)" class="legend"></g>
  </svg>
  <svg id="promiseLegend">
      <g transform="translate(20,20)" class="legend"></g>
  </svg>
</body>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script> -->
<!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
<!-- import other required components -->
<script type="importmap">
  {
      "imports": {
        "d3-array": "/web_modules/d3-array.js",
        "d3-selection": "/web_modules/d3-selection.js",
        "d3-dispatch": "/web_modules/d3-dispatch.js",
        "d3-shape": "/web_modules/d3-shape.js",
        "d3-transition": "/web_modules/d3-transition.js",
        "d3-format": "/web_modules/d3-format.js",
        "d3-time-format": "/web_modules/d3-time-format.js",
        "d3-random": "/web_modules/d3-random.js",
        "d3-scale": "/web_modules/d3-scale.js",
        "d3-time": "/web_modules/d3-time.js",
        "d3-scale-chromatic": "/web_modules/d3-scale-chromatic.js",
        "d3-svg-legend": "/web_modules/d3-svg-legend.js",
        "d3-zoom": "/web_modules/d3-zoom.js",
        "api-viewer-element": "/web_modules/api-viewer-element.js"
    }
  }
  </script>
<!-- <script src="../d3-legend.js"></script> -->
<script type="module">

import { legendColor } from '../index.js';
import { select } from "d3-selection";
import { scaleThreshold, scaleLinear } from 'd3-scale';
import { range } from 'd3-array';
import { format } from 'd3-format';
import 'd3-transition';
// import {  } from 'd3-format';

var thresholdScale = scaleThreshold()
  .domain([0, 1000, 2500, 5000, 10000])
  .range(range(6)
    .map(function(i) { return "q" + i + "-9" }));

var linear = scaleLinear()
  .domain([0, 10])
  .range(["rgb(46, 73, 123)", "rgb(71, 187, 94)"]);

// ----legendHelpers.thresholdLabels----
const promiseHelper = function({
  i,
  genLength,
  generatedLabels,
  labelDelimiter
}) {

  //
  const promise =  Promise.resolve()
    .then(function(string) {
      return new Promise(function(resolve, reject) {
        setTimeout(function() {
          let res;
          if (i === 0) {
            const values = generatedLabels[i].split(` ${labelDelimiter} `);
            return resolve(`Less than ${values[1]}`);
          } else if (i === genLength - 1) {
            const values = generatedLabels[i].split(` ${labelDelimiter} `);
            return resolve(`${values[0]} or more`);
          }
          return resolve(generatedLabels[i]);
        }, 100);
      });
    });

  return promise;  
};

// ----legendHelpers.thresholdLabels----
const helper = function({
  i,
  genLength,
  generatedLabels,
  labelDelimiter
}) {

  if (i === 0) {
    const values = generatedLabels[i].split(` ${labelDelimiter} `);
    return `Less than ${values[1]}`;
  } else if (i === genLength - 1) {
    const values = generatedLabels[i].split(` ${labelDelimiter} `);
    return `${values[0]} or more`;
  }
  return generatedLabels[i];
};

const legend = legendColor()
  .labelFormat(format('.2f'))
  .title('Sync labels')
  .labels(helper)
  .useClass(true)
  .scale(thresholdScale);

const promiseLegend = legendColor()
  .labelFormat(format('.2f'))
  .title('Async labels (Promise)')
  .labels(promiseHelper)
  .useClass(true)
  .scale(thresholdScale);



select('#legend .legend')
  .call(legend);

select('#promiseLegend .legend')
  .call(promiseLegend);

// Note(cg): remove one scale item 
thresholdScale
  .domain([0, 1000, 2500, 5000])
  .range(range(5)
    .map(function(i) { return "q" + i + "-9" }));

select('#legend .legend')
  .call(legend);  

select('#promiseLegend .legend')
  .call(promiseLegend);

</script>
